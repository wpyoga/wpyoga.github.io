<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="William&#39;s GitHub Pages RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="William&#39;s GitHub Pages Atom Feed"><title data-react-helmet="true">Libvirt Networking Configuration | William&#x27;s GitHub Pages</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://wpyoga.github.io/blog/2022/01/27/libvirt-networking"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Libvirt Networking Configuration | William&#x27;s GitHub Pages"><meta data-react-helmet="true" name="description" content="If you use a wireless adapter on your VM host, libvirt networking is complicated. We have 3 options:"><meta data-react-helmet="true" property="og:description" content="If you use a wireless adapter on your VM host, libvirt networking is complicated. We have 3 options:"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-01-27T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="libvirt,networking,bridged,routed,nat,dmz"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://wpyoga.github.io/blog/2022/01/27/libvirt-networking"><link data-react-helmet="true" rel="alternate" href="https://wpyoga.github.io/blog/2022/01/27/libvirt-networking" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wpyoga.github.io/blog/2022/01/27/libvirt-networking" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.935e0c88.css">
<link rel="preload" href="/assets/js/runtime~main.b349fb02.js" as="script">
<link rel="preload" href="/assets/js/main.0e2790e2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">William&#x27;s GitHub Pages site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Docusaurus Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a href="https://wpyoga.github.io/boto3-docs-reformat/html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Boto3 Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">All posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/04/27/linux-mint-oem-kernel">Linux Mint OEM Kernel</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/04/27/thinkpad-t14-trackpoint-linux">ThinkPad T14 TrackPoint &amp; Linux</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/04/27/thinkpad-t14">ThinkPad T14</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/03/17/migrating-windows-10">Migrating Windows 10 from HDD to SSD using Linux</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/02/14/show-in-folder">Show Items in Folder</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2022/01/27/libvirt-networking">Libvirt Networking Configuration</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/26/installing-proxmox-ve-on-debian-bullseye">Installing Proxmox VE on Debian Bullseye</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/24/vaccine-certrificate">Vaccination Certificate Download Via PeduliLindungi</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/22/server-wifi-disconnected">When My Server&#x27;s Wi-Fi Got Disconnected</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/19/deciphering-aptitude-search-results">Deciphering Aptitude Search Results</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/17/installing-openvz-6">Installing OpenVZ 6</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/30/oracle-cloud-instance-ipv6">Enabling IPv6 on Oracle Cloud Instance</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/26/dnf-ipv6">Using DNF on an IPv6-only host</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/15/vue-component-tag-name">Vue.js Component vs HTML Tag Names</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/21/nvm-sdkman-fast-loading">Fast Loading for `nvm` and SDKMAN!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/11/bash-slow-start">Bash Shell Slow Start-up</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/11/manual-profiling-bash-script">Manual Profiling of Bash Script Execution</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/10/bashrc-directory">Using a `.bashrc.d` directory instead of just `.bashrc`</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/16/github-main-branch">GitHub `main` branch</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/13/possible-webpack-dirname-bug">Possible dirname bug in Webpack</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/12/docusaurus-deploy">Deploying Docusaurus site to GitHub the easy way</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/12/docusaurus-install">Making a new blog with Docusaurus v2</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/05/08/inotifywait-problem">Problem with inotifywait, VSCode, and Maven</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Libvirt Networking Configuration</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2022-01-27T00:00:00.000Z" itemprop="datePublished">January 27, 2022</time></div></header><div class="markdown" itemprop="articleBody"><p>If you use a wireless adapter on your VM host, libvirt networking is complicated. We have 3 options:</p><ul><li>Bridged (with parprouted)</li><li>Routed</li><li>NAT (the default)</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="bridged">Bridged<a class="hash-link" href="#bridged" title="Direct link to heading">â€‹</a></h2><p>In this scenario, the virtual machines appear as &quot;real&quot; nodes in the local network. Using wired connections (Ethernet) it&#x27;s very easy to set up. However, due to <a href="https://superuser.com/a/1009881" target="_blank" rel="noopener noreferrer">the way wireless networks work</a>, bridging becomes a bit more complicated.</p><p>The core issue is: when a wireless client wants to send a packet to another host, it has to send 3 MAC addresses to the AP:</p><ul><li>AP&#x27;s MAC address</li><li>Client&#x27;s MAC address</li><li>Destination MAC address</li></ul><p>Remember that in AP / Managed mode, all communication has to pass through the AP. And each client to the AP needs to fill in its own MAC address as the Source address. If the client sends a MAC address belonging to a hosted virtual machine, that MAC address does not match the authenticated client&#x27;s MAC address, so the AP will reject it.</p><p>To solve this issue, we need to use an arp proxy. The manual way of doing this is using the <code>arp</code> utility. The automatic way is using <code>parprouted</code>. With an ARP proxy in place, the wireless client will send out forwarded packets with the MAC address changed to its authenticated MAC address. When packets come back, the MAC address is still the client&#x27;s MAC address, but the IP address is the VM&#x27;s IP address. The ARP proxy sees the destination IP address, looks it up in a table, and replaces the destination MAC address of the packet to be the destination VM&#x27;s MAC address.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="routed">Routed<a class="hash-link" href="#routed" title="Direct link to heading">â€‹</a></h2><p>Routed is basically NAT, with 2 major differences:</p><ul><li>Incoming connections are allowed and routed to the requested hosts</li><li>Outgoing connections still bear their original IP address</li></ul><p>However, without a static route set up on the gateway, the VM&#x27;s cannot access anything outside the local network. When it tries to do so, the gateway will be unable to return packets -- it doesn&#x27;t know where to send the packets to.</p><p>Setting up static routes on other machines in the local network only enable communication between the nodes and the VM&#x27;s.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="nat">NAT<a class="hash-link" href="#nat" title="Direct link to heading">â€‹</a></h2><p>With this set up:</p><ul><li>Incoming connections are not allowed, unless initiated by a VM. This means nodes in the local network cannot access VM&#x27;s.</li><li>Outgoing connections are masqueraded, so the gateway knows where to send the return packets to. This means the VM&#x27;s can access the local network and everything outside the local network.</li></ul><p>To enable seamless internode communication, we need to:</p><ul><li>Allow incoming connections. This effectively makes the whole NAT subnet be a DMZ.</li><li>Forward connections to nested VM&#x27;s within virtualized NAT networks.</li></ul><p>To allow incoming connections, we need to do two things:</p><ul><li>remove this rule: <code>-A LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp-port-unreachable</code></li><li>forward connections:<ul><li>192.168.124.0/24 via 192.168.122.223</li><li>192.168.125.0/24 via 192.168.122.74</li><li>192.168.126.0/24 via 192.168.122.91</li></ul></li></ul><div class="codeBlockContainer_K1bP language-xml theme-code-block"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">route</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">192.168.124.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">prefix</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">24</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">gateway</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">192.168.122.223</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">route</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">192.168.125.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">prefix</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">24</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">gateway</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">192.168.122.74</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">route</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">192.168.126.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">prefix</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">24</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">gateway</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">192.168.122.91</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To enable forwarding, we need to manipulate iptables rules using hooks. Be careful though, when a qemu hook is called, and a non-zero exit status is returned, all domains are destroyed.</p><p>If a hook script is not executable, then a log line will be printed on libvirtd&#x27;s log. But domains can be started and stopped.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="open">Open<a class="hash-link" href="#open" title="Direct link to heading">â€‹</a></h2><p>With &quot;Open&quot; mode, no iptables rules are set by default. We would then need to specify our own rules.</p><p>TODO: Propose a &quot;Custom&quot; mode, so that we don&#x27;t need to use hooks</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="events">Events<a class="hash-link" href="#events" title="Direct link to heading">â€‹</a></h3><p>TODO: propose a multi-level tree of drop-in scripts:
make a sample implementation using scripts</p><p>/etc/libvirtd/hooks/qemu.d/guest1/prepare/begin
/etc/libvirtd/hooks/qemu.d/guest1/start/begin
/etc/libvirtd/hooks/qemu.d/guest1/started/begin
/etc/libvirtd/hooks/qemu.d/guest1/stopped/end</p><p><a href="https://libvirt.org/hooks.html" target="_blank" rel="noopener noreferrer">https://libvirt.org/hooks.html</a></p><ul><li>virsh net-destroy
iptables rules for the network are deleted</li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default stopped end -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>virsh net-start
iptables rules for the network are applied</li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default start begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default started begin -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>virsh start</li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 prepare begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default port-created begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 start begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 started begin -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>if a domain is started but its network is not active, the domain will fail to start</p><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 prepare begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 stopped end -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 release end -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>virsh shutdown / virsh destroy</li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 stopped end -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default port-deleted begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ub16 release end -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>systemctl stop libvirtd
iptables rules are not touched</li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/daemon - shutdown - shutdown</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>systemctl start libvirtd
iptables rules for the active networks are applied</li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/daemon - start - start</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>networks marked as &quot;Autostart&quot; are not started
domains that are running trigger these events</p><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default port-created begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/qemu ovz6 reconnect begin -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><p>systemctl restart libvirtd
same as stop then immediately start</p></li><li><p>systemctl reload libvirtd
the daemon hook is run before the iptables rules are applied
iptables rules for the active networks are applied</p></li></ul><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/daemon - reload begin SIGHUP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>if some networks marked as &quot;Autostart&quot; are not active, then those networks are started, and triggers these events:</p><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default start begin -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/libvirt/hooks/network default started begin -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>if libvirtd is running, base libvirt chains are created:</p><div class="codeBlockContainer_K1bP theme-code-block"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">*mangle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A POSTROUTING -j LIBVIRT_PRT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*nat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A POSTROUTING -j LIBVIRT_PRT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*filter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -j LIBVIRT_INP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A FORWARD -j LIBVIRT_FWX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A FORWARD -j LIBVIRT_FWI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A FORWARD -j LIBVIRT_FWO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A OUTPUT -j LIBVIRT_OUT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/libvirt">libvirt</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/networking">networking</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/bridged">bridged</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/routed">routed</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/nat">nat</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/dmz">dmz</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/wpyoga/wpyoga.github.io/edit/master/blog/2022-01-27-libvirt-networking.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2022/02/14/show-in-folder"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->Show Items in Folder</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/01/26/installing-proxmox-ve-on-debian-bullseye"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Installing Proxmox VE on Debian Bullseye<!-- --> Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bridged" class="table-of-contents__link toc-highlight">Bridged</a></li><li><a href="#routed" class="table-of-contents__link toc-highlight">Routed</a></li><li><a href="#nat" class="table-of-contents__link toc-highlight">NAT</a></li><li><a href="#open" class="table-of-contents__link toc-highlight">Open</a><ul><li><a href="#events" class="table-of-contents__link toc-highlight">Events</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Docusaurus Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items"><li class="footer__item"><a href="https://www.facebook.com/william.poetra.yoga" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.instagram.com/williampoetra" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.reddit.com/user/wpyh" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Favourite Sites</div><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">My Websites</div><ul class="footer__items"><li class="footer__item"><a href="https://ipaddr.my.id" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>IP Address Check<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://wpyoga.blogspot.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>My Old Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/wpyoga/wpyoga.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www-uxsup.csx.cam.ac.uk/misc/horror.txt" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Unix Horror Stories<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 William Poetra Yoga / gmail: william dot poetra / gmail: wpyoga86</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b349fb02.js"></script>
<script src="/assets/js/main.0e2790e2.js"></script>
</body>
</html>