"use strict";(self.webpackChunkwpyoga_docusaurus_blog=self.webpackChunkwpyoga_docusaurus_blog||[]).push([[9558],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=a,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||o;return n?r.createElement(h,i(i({ref:t},u),{},{components:n})):r.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8412:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return u},toc:function(){return d},default:function(){return m}});var r=n(3117),a=n(102),o=(n(7294),n(3905)),i=["components"],l={title:"Installing Proxmox VE on Debian Bullseye",tags:["proxmox","debian"]},s=void 0,p={permalink:"/blog/2022/01/26/installing-proxmox-ve-on-debian-bullseye",editUrl:"https://github.com/wpyoga/wpyoga.github.io/edit/master/blog/2022-01-26-installing-proxmox-ve-on-debian-bullseye.md",source:"@site/blog/2022-01-26-installing-proxmox-ve-on-debian-bullseye.md",title:"Installing Proxmox VE on Debian Bullseye",description:"I tried to install Proxmox VE 7.1 as a VM using libvirt, but ran into two issues:",date:"2022-01-26T00:00:00.000Z",formattedDate:"January 26, 2022",tags:[{label:"proxmox",permalink:"/blog/tags/proxmox"},{label:"debian",permalink:"/blog/tags/debian"}],truncated:!0,authors:[],prevItem:{title:"Libvirt Networking Configuration",permalink:"/blog/2022/01/27/libvirt-networking"},nextItem:{title:"Vaccination Certificate Download Via PeduliLindungi",permalink:"/blog/2022/01/24/vaccine-certrificate"}},u={authorsImageUrls:[]},d=[{value:"Background",id:"background",children:[],level:2},{value:"Planning",id:"planning",children:[],level:2},{value:"Base OS installation",id:"base-os-installation",children:[],level:2},{value:"Proxmox-specific changes",id:"proxmox-specific-changes",children:[],level:2},{value:"Reboot",id:"reboot",children:[],level:2},{value:"Create a non-root user",id:"create-a-non-root-user",children:[],level:2},{value:"Web GUI",id:"web-gui",children:[],level:2},{value:"Run Proxmox without a subscription",id:"run-proxmox-without-a-subscription",children:[],level:2},{value:"Create a network bridge",id:"create-a-network-bridge",children:[],level:2},{value:"Physical host network",id:"physical-host-network",children:[],level:2},{value:"Install dnsmasq to provide DHCP server",id:"install-dnsmasq-to-provide-dhcp-server",children:[],level:2},{value:"Use systemd-resolved to provide DHCP server",id:"use-systemd-resolved-to-provide-dhcp-server",children:[],level:2},{value:"Creating a VM",id:"creating-a-vm",children:[],level:2}],c={toc:d};function m(e){var t=e.components,n=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"I tried to install Proxmox VE 7.1 as a VM using libvirt, but ran into two issues:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The official ISO image cannot be booted as a regular Linux installation ISO, because it does not have Joliet extensions"),(0,o.kt)("li",{parentName:"ul"},"The official installer is GUI-based, so we cannot install it over a serial console")),(0,o.kt)("h2",{id:"background"},"Background"),(0,o.kt)("p",null,"I wanted to learn Proxmox. Since I already have a VM server using libvirt, I figured I should install Proxmox VE as a virtual machine. I've installed OpenVZ 6 and 7 before as virtual machines, so it should be straightforward."),(0,o.kt)("p",null,"However, as mentioned above, I ran into two issues. Therefore I will try to install Proxmox on Debian Bullseye instead, following this tutorial: ",(0,o.kt)("a",{parentName:"p",href:"https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_11_Bullseye"},"https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_11_Bullseye")),(0,o.kt)("h2",{id:"planning"},"Planning"),(0,o.kt)("p",null,"Base OS: Debian 11.2.0\nNetwork: 192.168.126.0/24"),(0,o.kt)("h2",{id:"base-os-installation"},"Base OS installation"),(0,o.kt)("p",null,"First, install Debian 11 as usual. The thing about Debian installers is that the location we choose determines our timezone. Suppose I live in Asia, and I would like my laptop to have the English (US) locale, what should I do?"),(0,o.kt)("p",null,"Therefore I usually pretend I'm in the USA, then change the timezone after installation is complete. This is much easier than changing the locale."),(0,o.kt)("h2",{id:"proxmox-specific-changes"},"Proxmox-specific changes"),(0,o.kt)("p",null,"After installation, ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/hosts")," will look something like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"127.0.0.1   localhost\n127.0.1.1   my-hostname\n\n# The following lines are desirable for IPv6 capable hosts\n::1     localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n")),(0,o.kt)("p",null,"First, check the ip address of the node. An internal IP address is fine. This can be done using ",(0,o.kt)("inlineCode",{parentName:"p"},"ip addr"),"."),(0,o.kt)("p",null,"Remove the line ",(0,o.kt)("inlineCode",{parentName:"p"},"127.0.1.1\tmy-hostname")," and replace it with the reachable IP address:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"192.168.122.91  my-hostname\n")),(0,o.kt)("p",null,"Note to self: submit a correction or register an account: ",(0,o.kt)("a",{parentName:"p",href:"https://forum.proxmox.com/threads/how-can-we-contribute-to-the-wiki.93970/"},"https://forum.proxmox.com/threads/how-can-we-contribute-to-the-wiki.93970/")),(0,o.kt)("h2",{id:"reboot"},"Reboot"),(0,o.kt)("p",null,"Now we shut down the VM, and enable nested virtualization for the libvirt domain: ",(0,o.kt)("a",{parentName:"p",href:"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_virtualization/creating-nested-virtual-machines_configuring-and-managing-virtualization"},"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_virtualization/creating-nested-virtual-machines_configuring-and-managing-virtualization")),(0,o.kt)("p",null,"Then start the domain again, which will boot into the Proxmox kernel."),(0,o.kt)("h2",{id:"create-a-non-root-user"},"Create a non-root user"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell-session"},"$ sudo pveum useradd william@pve\n$ sudo pveum passwd william@pve\n")),(0,o.kt)("p",null,"Note that ",(0,o.kt)("inlineCode",{parentName:"p"},"pve")," is the realm. This is not the node's hostname."),(0,o.kt)("p",null,"Also create a group for the user:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell-session"},"$ sudo pveum group add admin\n$ sudo pveum user modify william@pve -append -groups admin\n")),(0,o.kt)("p",null,"Then grant permissions to the group:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell-session"},"$ sudo pveum acl modify / --roles Administrator --groups admin\n")),(0,o.kt)("h2",{id:"web-gui"},"Web GUI"),(0,o.kt)("p",null,"Open ",(0,o.kt)("a",{parentName:"p",href:"https://192.168.122.91:8006/"},"https://192.168.122.91:8006/")," in a browser. Note that this is only accessible via HTTPS. Plain HTTP won't work."),(0,o.kt)("p",null,"Note to self: try to configure a redirect here (HTTP -> HTTPS)"),(0,o.kt)("h2",{id:"run-proxmox-without-a-subscription"},"Run Proxmox without a subscription"),(0,o.kt)("p",null,"Remove ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/apt/sources.list.d/pve-enterprise.list")),(0,o.kt)("p",null,"Note to self: try to figure out how to remove this automatically."),(0,o.kt)("h2",{id:"create-a-network-bridge"},"Create a network bridge"),(0,o.kt)("p",null,"Since my home server is connected to the router via Wi-Fi, let's create a bridge for a routed network.\n",(0,o.kt)("a",{parentName:"p",href:"https://192.168.122.91:8006/pve-docs/chapter-sysadmin.html#_routed_configuration"},"https://192.168.122.91:8006/pve-docs/chapter-sysadmin.html#_routed_configuration")),(0,o.kt)("p",null,"The bridge should get an IP address of .1 in a new subnet, and there should be no interface added to it.\nIn my example, the CIDR is 192.168.126.1/24."),(0,o.kt)("h2",{id:"physical-host-network"},"Physical host network"),(0,o.kt)("p",null,"on the physical host"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell-session"},"$ sudo ip route add 192.168.126.0/24 via 192.168.122.91\n")),(0,o.kt)("p",null,"or:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell-session"},"$ virsh net-edit default && virsh net-destroy default && virsh net-start default && sudo systemctl restart libvirtd\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},"<network>\n  ...\n  <route family='ipv4' address='192.168.126.0' prefix='24' gateway='192.168.122.91'/>\n</network>\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo iptables -I FORWARD -s 192.168.126.0/24 -i virbr0 -j ACCEPT\n$ sudo iptables -I FORWARD -d 192.168.126.0/24 -o virbr0 -j ACCEPT\n$ sudo iptables -t nat -A POSTROUTING -s 192.168.126.0/24 ! -d 192.168.126.0/24 -j MASQUERADE\n")),(0,o.kt)("p",null,"install iptables-persistent\nthen create /etc/iptables/rules.v4"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"*filter\n-A FORWARD -d 192.168.126.0/24 -o virbr0 -j ACCEPT\n-A FORWARD -s 192.168.126.0/24 -i virbr0 -j ACCEPT\n\n*nat\n-A POSTROUTING -s 192.168.126.0/24 ! -d 192.168.126.0/24 -j MASQUERADE\n")),(0,o.kt)("h2",{id:"install-dnsmasq-to-provide-dhcp-server"},"Install dnsmasq to provide DHCP server"),(0,o.kt)("p",null,"From: ",(0,o.kt)("a",{parentName:"p",href:"https://bobcares.com/blog/dnsmasq-dhcp-server-in-proxmox/"},"https://bobcares.com/blog/dnsmasq-dhcp-server-in-proxmox/")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo apt install dnsmasq\n")),(0,o.kt)("p",null,"Configure it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-title=/etc/dnsmasq.conf"},"domain-needed\nbogus-priv\ninterface=vmbr0\ndhcp-range=192.168.126.2,192.168.126.254,12h\n")),(0,o.kt)("p",null,"Then restart the dnsmasq service."),(0,o.kt)("h2",{id:"use-systemd-resolved-to-provide-dhcp-server"},"Use systemd-resolved to provide DHCP server"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://www.freedesktop.org/software/systemd/man/systemd.network.html"},"https://www.freedesktop.org/software/systemd/man/systemd.network.html")),(0,o.kt)("p",null,"Create a file ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/systemd/network/proxmox.network"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ini"},"[Match]\nName=vmbr*\nDriver=bridge\n\n[Network]\nAddress=192.168.126.1/24\nDHCPServer=yes\nIPMasquerade=yes\n\n[DHCPServer]\nDNS=8.8.8.8\n")),(0,o.kt)("p",null,"This will enable IP forwarding etc."),(0,o.kt)("h2",{id:"creating-a-vm"},"Creating a VM"),(0,o.kt)("p",null,"Put ISO files in ",(0,o.kt)("inlineCode",{parentName:"p"},"/var/lib/vz/template/iso")))}m.isMDXComponent=!0}}]);