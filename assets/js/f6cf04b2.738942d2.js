"use strict";(self.webpackChunkwpyoga_docusaurus_blog=self.webpackChunkwpyoga_docusaurus_blog||[]).push([[4410],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},l=Object.keys(e);for(o=0;o<l.length;o++)n=l[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(o=0;o<l.length;o++)n=l[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=p(n),h=r,m=d["".concat(s,".").concat(h)]||d[h]||c[h]||l;return n?o.createElement(m,a(a({ref:t},u),{},{components:n})):o.createElement(m,a({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,a=new Array(l);a[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,a[1]=i;for(var p=2;p<l;p++)a[p]=n[p];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6272:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return u},toc:function(){return c},default:function(){return h}});var o=n(3117),r=n(102),l=(n(7294),n(3905)),a=["components"],i={title:"Installing OpenVZ 6",tags:["openvz","centos","container","virtualization"]},s=void 0,p={permalink:"/blog/2022/01/17/installing-openvz-6",editUrl:"https://github.com/wpyoga/wpyoga.github.io/edit/master/blog/2022-01-17-installing-openvz-6.md",source:"@site/blog/2022-01-17-installing-openvz-6.md",title:"Installing OpenVZ 6",description:"OpenVZ 6 is an obsolete piece of technology. However, I have a small project whereby I upgrade a Ubuntu 16.04 installation to Ubuntu 18.04 and then 20.04 and eventually 22.04, completely disregarding any potential issues and problems that may happen :)",date:"2022-01-17T00:00:00.000Z",formattedDate:"January 17, 2022",tags:[{label:"openvz",permalink:"/blog/tags/openvz"},{label:"centos",permalink:"/blog/tags/centos"},{label:"container",permalink:"/blog/tags/container"},{label:"virtualization",permalink:"/blog/tags/virtualization"}],truncated:!0,authors:[],prevItem:{title:"Deciphering Aptitude Search Results",permalink:"/blog/2022/01/19/deciphering-aptitude-search-results"},nextItem:{title:"Enabling IPv6 on Oracle Cloud Instance",permalink:"/blog/2021/10/30/oracle-cloud-instance-ipv6"}},u={authorsImageUrls:[]},c=[{value:"Install CentOS 6",id:"install-centos-6",children:[],level:2},{value:"Install OpenVZ 6",id:"install-openvz-6",children:[{value:"If using veth",id:"if-using-veth",children:[],level:3},{value:"Create a container",id:"create-a-container",children:[],level:3},{value:"Configure networking",id:"configure-networking",children:[],level:3}],level:2}],d={toc:c};function h(e){var t=e.components,n=(0,r.Z)(e,a);return(0,l.kt)("wrapper",(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"OpenVZ 6 is an obsolete piece of technology. However, I have a small project whereby I upgrade a Ubuntu 16.04 installation to Ubuntu 18.04 and then 20.04 and eventually 22.04, completely disregarding any potential issues and problems that may happen :)"),(0,l.kt)("p",null,"Also, I may be able to research a migration strategy for OpenVZ 6 to KVM. One possible way is to install OpenVZ 6 inside a KVM virtual machine, and then migrating each container as a single container inside the new host."),(0,l.kt)("p",null,"The basic process is to install CentOS 6 as the base OS, then install OpenVZ 6 on top of it. After installation, we have to reboot into the newly-installed OpenVZ kernel. This is a modified kernel based off of RHEL 6 / CentOS 6 that provides the containerization features."),(0,l.kt)("p",null,"As a bonus, I'm installing all of this inside a KVM virtual machine."),(0,l.kt)("h2",{id:"install-centos-6"},"Install CentOS 6"),(0,l.kt)("p",null,'TODO: move this to another document "Installing CentOS 6 in 2022".'),(0,l.kt)("p",null,"download centos 6:\n",(0,l.kt)("a",{parentName:"p",href:"https://vault.centos.org/6.10/isos/x86_64/"},"https://vault.centos.org/6.10/isos/x86_64/"),"\n",(0,l.kt)("a",{parentName:"p",href:"http://ftp.uem.br/linux/CentOS/6.10/isos/x86_64/"},"http://ftp.uem.br/linux/CentOS/6.10/isos/x86_64/"),"\n",(0,l.kt)("a",{parentName:"p",href:"https://mirror.nsc.liu.se/centos-store/6.10/isos/x86_64/"},"https://mirror.nsc.liu.se/centos-store/6.10/isos/x86_64/"),"\n",(0,l.kt)("a",{parentName:"p",href:"http://ftp.iij.ad.jp/pub/linux/centos-vault/centos/6.10/isos/x86_64/"},"http://ftp.iij.ad.jp/pub/linux/centos-vault/centos/6.10/isos/x86_64/"),"\n",(0,l.kt)("a",{parentName:"p",href:"https://img.cs.montana.edu/linux/centos/6.10/isos/x86_64/"},"https://img.cs.montana.edu/linux/centos/6.10/isos/x86_64/")),(0,l.kt)("p",null,"install centos 6\nenable dhcp: ",(0,l.kt)("a",{parentName:"p",href:"https://www.serverlab.ca/tutorials/linux/administration-linux/configure-centos-6-network-settings/"},"https://www.serverlab.ca/tutorials/linux/administration-linux/configure-centos-6-network-settings/"),"\n(just change ONBOOT=yes)"),(0,l.kt)("p",null,"use vault repo (since centos 6 is already EOL)\n",(0,l.kt)("a",{parentName:"p",href:"https://www.getpagespeed.com/server-setup/how-to-fix-yum-after-centos-6-went-eol"},"https://www.getpagespeed.com/server-setup/how-to-fix-yum-after-centos-6-went-eol"),"\nedit /etc/yum.repos.d/CentOS-Base.repo\nremove all mirrorlist= lines\nuncomment all baseurl= lines, change the domain to vault.centos.org"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"$ sudo sed -i /etc/yum.repos.d/CentOS-Base.repo -e '/^mirrorlist=/d' -e 's,^#baseurl=http://mirror.centos.org/,baseurl=https://vault.centos.org/,'\n")),(0,l.kt)("p",null,"yum update"),(0,l.kt)("p",null,"make a new user"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"# useradd william -G adm\n")),(0,l.kt)("p",null,"change hostname"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"$ sudo hostname cos6\n$ vi /etc/sysconfig/network\nHOSTNAME=cos6\n")),(0,l.kt)("p",null,"enable sudo\n$ visudo william\nadd the line\nwilliam ALL=(ALL)   NOPASSWD:ALL"),(0,l.kt)("p",null,"enable ssh\n$ mkdir /home/william/.ssh\n$ vi /home/william/.ssh/authorized_keys\n$ chmod 700 /home/william/.ssh\n$ chown -R william: /home/william\n$ ls -la /home/william/.ssh"),(0,l.kt)("p",null,"install & enable acpid, so that the VM can be shut down gracefully by libvirt / proxmox"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"$ sudo yum install acpid\n$ sudo service acpid start\n$ sudo service acpid status\n")),(0,l.kt)("h2",{id:"install-openvz-6"},"Install OpenVZ 6"),(0,l.kt)("p",null,"then follow the instructions here:\n",(0,l.kt)("a",{parentName:"p",href:"https://wiki.openvz.org/Quick_Installation_CentOS_6"},"https://wiki.openvz.org/Quick_Installation_CentOS_6")),(0,l.kt)("p",null,"$ sudo curl ",(0,l.kt)("a",{parentName:"p",href:"http://download.openvz.org/openvz.repo"},"http://download.openvz.org/openvz.repo")," -o/etc/yum.repos.d/openvz.repo\n$ sudo rpm --import ",(0,l.kt)("a",{parentName:"p",href:"http://download.openvz.org/RPM-GPG-Key-OpenVZ"},"http://download.openvz.org/RPM-GPG-Key-OpenVZ"),"\n$ yum install vzkernel vzctl vzquota"),(0,l.kt)("h1",{id:"disable-disk-quota-system"},"disable disk quota system"),(0,l.kt)("p",null,"/etc/vz/vz.conf\nDISK_QUOTA=no"),(0,l.kt)("h1",{id:"you-can-install-ploop-but-it-is-not-recommended"},"you can install ploop, but it is not recommended"),(0,l.kt)("p",null,"/etc/vz/vz.conf\nVE_LAYOUT=simfs"),(0,l.kt)("p",null,"make sure vzkernel is the default boot option\n$ sudo vi /boot/grub/menu.lst"),(0,l.kt)("p",null,"enable ip forwarding etc\n$ sudo vi /etc/sysctl.conf\nnet.ipv4.ip_forward = 1\nnet.ipv4.conf.default.proxy_arp = 0\nnet.ipv4.conf.all.rp_filter = 1\n#kernel.sysrq = 1\nnet.ipv4.conf.default.send_redirects = 1\nnet.ipv4.conf.all.send_redirects = 0\nnet.ipv4.icmp_echo_ignore_broadcasts=1\nnet.ipv4.conf.default.forwarding=1"),(0,l.kt)("h3",{id:"if-using-veth"},"If using veth"),(0,l.kt)("p",null,'for VETH: create a bridge & configure vznet script\n$ sudo vi /etc/sysconfig/network-scripts/ifcfg-vmbr0\nDEVICE="vmbr0"\nBOOTPROTO="static"\nIPV6INIT="no"\nONBOOT="yes"\nTYPE="Bridge"\nDELAY=0\nIPADDR=192.168.124.99\nNETMASK=255.255.255.0\nGATEWAY=192.168.124.1\n$ sudo vi /etc/sysconfig/network-scripts/ifcfg-eth0\nDEVICE=eth0\nTYPE=Ethernet\nONBOOT=yes\nIPV6INIT=no\nBRIDGE=vmbr0\n$ sudo vi /etc/vz/vznet.conf\nEXTERNAL_SCRIPT=/usr/sbin/vznetaddbr'),(0,l.kt)("h3",{id:"create-a-container"},"Create a container"),(0,l.kt)("p",null,"create container\n$ sudo vzctl create 101 --ostemplate ubuntu-16.04-x86_64 --layout simfs --hostname server101 --ipadd 192.168.124.101 --diskspace 8G\n$ sudo vzctl set 101 --save --onboot yes --nameserver 8.8.8.8 --cpus 1 --ram 1G"),(0,l.kt)("h1",{id:"use---name-server101-"},"use --name server101 ???"),(0,l.kt)("p",null,"note: if using ploop, sometimes container can run out of disk space, especially when there is lots of writing and erasing. to solve this: ploop discard -d /dev/ploopXXXXX / or / vzctl compact 101\nit's much simpler to just use simfs though"),(0,l.kt)("p",null,"configure venet: ",(0,l.kt)("a",{parentName:"p",href:"https://wiki.openvz.org/Virtual_network_device"},"https://wiki.openvz.org/Virtual_network_device")),(0,l.kt)("p",null,"$ sudo vzctl start 101"),(0,l.kt)("h1",{id:"ubuntu-1604-template"},"ubuntu 16.04 template"),(0,l.kt)("h1",{id:"ubuntu-useradd-needs-extra-options"},"ubuntu useradd needs extra options"),(0,l.kt)("p",null,"$ sudo vzctl exec 101 useradd -m -s /bin/bash william\n$ sudo vzctl exec 101 usermod -a -G systemd-journal william\n$ sudo vzctl exec 101 mkdir /home/william/.ssh\n$ sudo vi /vz/root/101/home/william/.ssh/authorized_keys\n$ sudo vzctl exec 101 chmod 700 /home/william/.ssh\n$ sudo vzctl exec 101 chown -R william: /home/william\n$ sudo vzctl exec 101 ls -la /home/william/.ssh"),(0,l.kt)("p",null,"$ sudo vi /vz/root/101/etc/sudoers\nwilliam ALL=(ALL:ALL) NOPASSWD: ALL"),(0,l.kt)("p",null,"login to the node, then\n$ sudo dpkg-reconfigure locales\nselect en_US.UTF-8 to generate\nand select en_US.UTF-8 as the system default locale"),(0,l.kt)("hr",null),(0,l.kt)("p",null,"to list all containers: vzlist --all"),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"configure-networking"},"Configure networking"),(0,l.kt)("p",null,"on the openvz host\n$ sudo iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited"),(0,l.kt)("p",null,"/etc/sysconfig/iptables\nremove the line:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n")),(0,l.kt)("p",null,"on the physical host"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"$ sudo ip route add 192.168.124.0/24 via 192.168.122.223\n")),(0,l.kt)("p",null,"or:"),(0,l.kt)("p",null,"$ virsh net-edit default && virsh net-destroy default && virsh net-start default && sudo systemctl restart libvirtd"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-xml"},"<network>\n  ...\n  <route family='ipv4' address='192.168.124.0' prefix='24' gateway='192.168.122.223'/>\n</network>\n")),(0,l.kt)("h1",{id:"on-the-physical-host-copy-libvirt-rules"},"on the physical host: copy libvirt rules"),(0,l.kt)("h1",{id:"the-last-rule-is-actually-the-most-important-one"},"the last rule is actually the most important one"),(0,l.kt)("p",null,"sudo iptables -D LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp-port-unreachable\nsudo iptables -I FORWARD -s 192.168.124.0/24 -i virbr0 -j ACCEPT\nsudo iptables -I FORWARD -d 192.168.124.0/24 -o virbr0 -j ACCEPT\nsudo iptables -t nat -A POSTROUTING -s 192.168.124.0/24 ! -d 192.168.124.0/24 -j MASQUERADE"),(0,l.kt)("p",null,"install iptables-persistent\nthen create /etc/iptables/rules.v4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"*filter\n-A FORWARD -d 192.168.124.0/24 -o virbr0 -j ACCEPT\n-A FORWARD -s 192.168.124.0/24 -i virbr0 -j ACCEPT\nCOMMIT\n\n*nat\n-A POSTROUTING -s 192.168.124.0/24 ! -d 192.168.124.0/24 -j MASQUERADE\nCOMMIT\n")),(0,l.kt)("p",null,"don't save the libvirt and wireguard rules to that file, those rules will be recreated when the corresponding services are started"))}h.isMDXComponent=!0}}]);