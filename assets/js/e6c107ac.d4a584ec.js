"use strict";(self.webpackChunkwpyoga_docusaurus_blog=self.webpackChunkwpyoga_docusaurus_blog||[]).push([[2563],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return u}});var a=n(7294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,l=function(e,t){if(null==e)return{};var n,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var i=a.createContext({}),h=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=h(e.components);return a.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,l=e.mdxType,r=e.originalType,i=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),c=h(n),u=l,d=c["".concat(i,".").concat(u)]||c[u]||p[u]||r;return n?a.createElement(d,o(o({ref:t},m),{},{components:n})):a.createElement(d,o({ref:t},m))}));function u(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=n.length,o=new Array(r);o[0]=c;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:l,o[1]=s;for(var h=2;h<r;h++)o[h]=n[h];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4097:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return i},metadata:function(){return h},assets:function(){return m},toc:function(){return p},default:function(){return u}});var a=n(3117),l=n(102),r=(n(7294),n(3905)),o=["components"],s={title:"Bash Shell Slow Start-up",tags:["bash","shell","slow","nvm","sdkman"]},i=void 0,h={permalink:"/blog/2021/07/11/bash-slow-start",editUrl:"https://github.com/wpyoga/wpyoga.github.io/edit/master/blog/2021-07-11-bash-slow-start.md",source:"@site/blog/2021-07-11-bash-slow-start.md",title:"Bash Shell Slow Start-up",description:"As we install development environments in our system, we may notice that terminal start-up can become slow. Some people notice it, some don't -- but the reality is, it's there.",date:"2021-07-11T00:00:00.000Z",formattedDate:"July 11, 2021",tags:[{label:"bash",permalink:"/blog/tags/bash"},{label:"shell",permalink:"/blog/tags/shell"},{label:"slow",permalink:"/blog/tags/slow"},{label:"nvm",permalink:"/blog/tags/nvm"},{label:"sdkman",permalink:"/blog/tags/sdkman"}],truncated:!0,authors:[],prevItem:{title:"Fast Loading for `nvm` and SDKMAN!",permalink:"/blog/2021/07/21/nvm-sdkman-fast-loading"},nextItem:{title:"Manual Profiling of Bash Script Execution",permalink:"/blog/2021/07/11/manual-profiling-bash-script"}},m={authorsImageUrls:[]},p=[{value:"Finding the culprit",id:"finding-the-culprit",children:[],level:2},{value:"The solution",id:"the-solution",children:[],level:2},{value:"A little snag",id:"a-little-snag",children:[],level:2},{value:"Anything else?",id:"anything-else",children:[],level:2}],c={toc:p};function u(e){var t=e.components,n=(0,l.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"As we install development environments in our system, we may notice that terminal start-up can become slow. Some people notice it, some don't -- but the reality is, it's there."),(0,r.kt)("h2",{id:"finding-the-culprit"},"Finding the culprit"),(0,r.kt)("p",null,"This initially started when I was ",(0,r.kt)("a",{parentName:"p",href:"/blog/2021/07/10/bashrc-directory#self-cleaning-implementation"},"looking at bash start-up time"),", and that's when I noticed that ",(0,r.kt)("inlineCode",{parentName:"p"},"nvm")," loading was a bit slow."),(0,r.kt)("p",null,"Here's how I found out, by printing the time taken to execute commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'for i in "${HOME}/.bashrc.d"/[0-9][0-9]-*.bashrc; do\n  if [ -r "$i" ]; then\n    export TIMEFORMAT="%R $i"\n    time . "$i"\n  fi\ndone\nunset i\nunset TIMEFORMAT\n')),(0,r.kt)("p",null,"That gives me this printout when I open a new terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"0.051 /home/william/.bashrc.d/00-default.bashrc\n0.000 /home/william/.bashrc.d/50-android-sdk.bashrc\n0.000 /home/william/.bashrc.d/50-android-studio.bashrc\n0.008 /home/william/.bashrc.d/50-asdf.bashrc\n0.266 /home/william/.bashrc.d/50-nvm.bashrc\n0.037 /home/william/.bashrc.d/50-sdkman.bashrc\n0.000 /home/william/.bashrc.d/90-gradle-opts.bashrc\n")),(0,r.kt)("p",null,"There is another thing that I should check:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"export TIMEFORMAT='%R bashrc check'\ntime if which mktemp >/dev/null 2>&1; then\n  ...\n")),(0,r.kt)("p",null,"Which gives me:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"0.019 bashrc check\n")),(0,r.kt)("p",null,"So, it seems that ",(0,r.kt)("inlineCode",{parentName:"p"},"nvm")," takes the longest time, followed by the default bashrc and then ",(0,r.kt)("inlineCode",{parentName:"p"},"SDKMAN!"),"."),(0,r.kt)("p",null,"The problem with slow loading has been experienced by other people:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/nvm-sh/nvm/issues/1261"},"https://github.com/nvm-sh/nvm/issues/1261")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/nvm-sh/nvm/issues/1277"},"https://github.com/nvm-sh/nvm/issues/1277"))),(0,r.kt)("p",null,"Although I'm lucky to now have experienced such slow loading myself."),(0,r.kt)("h2",{id:"the-solution"},"The solution"),(0,r.kt)("p",null,"Just like most good ideas, others have already thought about it:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://gist.github.com/rtfpessoa/811701ed8fa642f60e411aef04b2b64a"},"https://gist.github.com/rtfpessoa/811701ed8fa642f60e411aef04b2b64a")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://armno.in.th/2020/08/24/lazyload-nvm-to-reduce-zsh-startup-time/"},"https://armno.in.th/2020/08/24/lazyload-nvm-to-reduce-zsh-startup-time/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.ioannispoulakas.com/2020/02/22/how-to-speed-up-shell-load-while-using-nvm/"},"https://www.ioannispoulakas.com/2020/02/22/how-to-speed-up-shell-load-while-using-nvm/"))),(0,r.kt)("p",null,"But ",(0,r.kt)("a",{parentName:"p",href:"http://broken-by.me/lazy-load-nvm/"},"this one")," looks the most promising."),(0,r.kt)("p",null,"So I adapted it for my own use:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'nvm() {\n  unset -f nvm node npm\n  export NVM_DIR="${HOME}/.nvm"\n  [ -s "${NVM_DIR}/nvm.sh" ] && . "${NVM_DIR}/nvm.sh"\n  [ -s "${NVM_DIR}/bash_completion" ] && . "${NVM_DIR}/bash_completion"\n  nvm "$@"\n}\n\nnode() {\n  unset -f nvm node npm\n  export NVM_DIR="${HOME}/.nvm"\n  [ -s "${NVM_DIR}/nvm.sh" ] && . "${NVM_DIR}/nvm.sh"\n  [ -s "${NVM_DIR}/bash_completion" ] && . "${NVM_DIR}/bash_completion"\n  node "$@"\n}\n\nnpm() {\n  unset -f nvm node npm\n  export NVM_DIR="${HOME}/.nvm"\n  [ -s "${NVM_DIR}/nvm.sh" ] && . "${NVM_DIR}/nvm.sh"\n  [ -s "${NVM_DIR}/bash_completion" ] && . "${NVM_DIR}/bash_completion"\n  npm "$@"\n}\n')),(0,r.kt)("p",null,"Now the timings have improved:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"0.034 /home/william/.bashrc.d/00-default.bashrc\n0.000 /home/william/.bashrc.d/50-android-sdk.bashrc\n0.000 /home/william/.bashrc.d/50-android-studio.bashrc\n0.002 /home/william/.bashrc.d/50-asdf.bashrc\n0.000 /home/william/.bashrc.d/50-nvm.bashrc\n0.039 /home/william/.bashrc.d/50-sdkman.bashrc\n0.000 /home/william/.bashrc.d/90-gradle-opts.bashrc\n0.018 bashrc check\n")),(0,r.kt)("h2",{id:"a-little-snag"},"A little snag"),(0,r.kt)("p",null,"With this setup, ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn")," cannot be called without calling ",(0,r.kt)("inlineCode",{parentName:"p"},"nvm")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"node")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"npm")," first, because it's not in the PATH."),(0,r.kt)("p",null,"No solutions for this yet -- maybe we can do some kind of late-loading instead of lazy-loading."),(0,r.kt)("p",null,"Or maybe, we can make nvm load faster... somehow?"),(0,r.kt)("h2",{id:"anything-else"},"Anything else?"),(0,r.kt)("p",null,"Let's use the same technique for SDKMAN! as well then:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'sdk() {\n  unset -f sdk\n  export SDKMAN_DIR="${HOME}/.sdkman"\n  [ -s "${SDKMAN_DIR}/bin/sdkman-init.sh" ] && . "${SDKMAN_DIR}/bin/sdkman-init.sh"\n  sdk "$@"\n}\n')),(0,r.kt)("p",null,"With this, we have shaved more time off our start-up:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"0.060 /home/william/.bashrc.d/00-default.bashrc\n0.000 /home/william/.bashrc.d/50-android-sdk.bashrc\n0.000 /home/william/.bashrc.d/50-android-studio.bashrc\n0.004 /home/william/.bashrc.d/50-asdf.bashrc\n0.000 /home/william/.bashrc.d/50-nvm.bashrc\n0.000 /home/william/.bashrc.d/50-sdkman.bashrc\n0.000 /home/william/.bashrc.d/90-gradle-opts.bashrc\n0.018 bashrc check\n")),(0,r.kt)("p",null,"Great, now we just have to worry about the default ",(0,r.kt)("inlineCode",{parentName:"p"},".bashrc")," and the checking part :)"),(0,r.kt)("p",null,"But that's another matter for another day."))}u.isMDXComponent=!0}}]);