"use strict";(self.webpackChunkwpyoga_docusaurus_blog=self.webpackChunkwpyoga_docusaurus_blog||[]).push([[1896],{3905:function(e,t,n){n.d(t,{Zo:function(){return l},kt:function(){return h}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),u=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=u(e.components);return o.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(n),h=a,m=p["".concat(s,".").concat(h)]||p[h]||d[h]||r;return n?o.createElement(m,i(i({ref:t},l),{},{components:n})):o.createElement(m,i({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=p;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var u=2;u<r;u++)i[u]=n[u];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},620:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return c},contentTitle:function(){return s},metadata:function(){return u},assets:function(){return l},toc:function(){return d},default:function(){return h}});var o=n(3117),a=n(102),r=(n(7294),n(3905)),i=["components"],c={title:"When My Server's Wi-Fi Got Disconnected",tags:["wifi","NetworkManager"]},s=void 0,u={permalink:"/blog/2022/01/22/server-wifi-disconnected",editUrl:"https://github.com/wpyoga/wpyoga.github.io/edit/master/blog/2022-01-22-server-wifi-disconnected.md",source:"@site/blog/2022-01-22-server-wifi-disconnected.md",title:"When My Server's Wi-Fi Got Disconnected",description:"A few days ago, I just installed an NVMe SSD on my home server. Then I went on a quick trip, and found out that I couldn't access my server anymore. I had thought to myself, could it be that the SSD was bad? (I bought it used, but barely)",date:"2022-01-22T00:00:00.000Z",formattedDate:"January 22, 2022",tags:[{label:"wifi",permalink:"/blog/tags/wifi"},{label:"NetworkManager",permalink:"/blog/tags/network-manager"}],truncated:!0,authors:[],prevItem:{title:"Vaccination Certificate Download Via PeduliLindungi",permalink:"/blog/2022/01/24/vaccine-certrificate"},nextItem:{title:"Deciphering Aptitude Search Results",permalink:"/blog/2022/01/19/deciphering-aptitude-search-results"}},l={authorsImageUrls:[]},d=[{value:"Initial discovery",id:"initial-discovery",children:[],level:2},{value:"Back home",id:"back-home",children:[],level:2},{value:"Figuring out the issue",id:"figuring-out-the-issue",children:[],level:2},{value:"The solution",id:"the-solution",children:[],level:2}],p={toc:d};function h(e){var t=e.components,n=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"A few days ago, I just installed an NVMe SSD on my home server. Then I went on a quick trip, and found out that I couldn't access my server anymore. I had thought to myself, could it be that the SSD was bad? (I bought it used, but barely)"),(0,r.kt)("p",null,"It turns out that the default NetworkManager settings are not suitable for my use-case, as described by ",(0,r.kt)("a",{parentName:"p",href:"https://community.home-assistant.io/t/wifi-does-not-reconnect-if-router-was-gone/247532/5"},"this forum post"),":"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The ",(0,r.kt)("a",{parentName:"p",href:"https://developer.gnome.org/NetworkManager/stable/settings-connection.html"},"nmcli docs")," state:"),(0,r.kt)("blockquote",{parentName:"blockquote"},(0,r.kt)("p",{parentName:"blockquote"},"The number of times a connection should be tried when autoactivating before giving up. Zero means forever, -1 means the global default (4 times if not overridden).")),(0,r.kt)("p",{parentName:"blockquote"},"Four? Why four? Why not 42? What kind of default is that supposed to be?\nKind of \u201cPlease try, but not that hard.\u201d \ud83d\ude42")),(0,r.kt)("p",null,"Before you say anything, yes I use a Wi-Fi adapter for my home server. It's just an educational server running a few VM's, so Wi-Fi makes sense here. Running a cable between the server and the router would have complicated the installation."),(0,r.kt)("h2",{id:"initial-discovery"},"Initial discovery"),(0,r.kt)("p",null,"I was in my hotel room, checking up on my home server, when I found that it cannot be accessed. Note that I live in a third-world country, where IP addresses are not given out to home broadband subscribers anymore, so I have to rely on a reverse proxy or VPN to access my home network."),(0,r.kt)("p",null,"I checked my reverse proxy, the proxy server is up and running. When I checked my VPN, it shows that my home server had disconnected the previous night. I had indeed installed an NVMe SSD the previous night, and I thought the SSD might have been corrupted (I'm running a few VM's on it), or maybe the PCIe adapter was broken (no more space for an additional NVMe SSD on the motherboard)."),(0,r.kt)("p",null,"Another possibility that came to mind was, one or more VM's used up all the memory, and the VPN client died due to an OOM condition. Not sure if this is possible in reality. Or, maybe the Wi-Fi adapter (it's a cheap USB adapter)"),(0,r.kt)("p",null,"Anyway, I didn't think much about it, and waited until I could get home to diagnose the issue."),(0,r.kt)("h2",{id:"back-home"},"Back home"),(0,r.kt)("p",null,"As soon as I got back home, I checked the server and saw that it's still powered on. I tried pinging the server and got no response. I tried unplugging and plugging the Wi-Fi adapter, and the server was back online after the second try. It was then that I remembered, I had unplugged the Wi-Fi access point right around the time the VPN client was disconnected."),(0,r.kt)("h2",{id:"figuring-out-the-issue"},"Figuring out the issue"),(0,r.kt)("p",null,"I was hoping for some Wi-Fi driver crash to explain the issue, but found nothing in dmesg. Then I looked at NetworkManager logs and found this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Jan 20 21:46:48 wmpc NetworkManager[734]: <info>  [1642690008.5546] manager: NetworkManager state is now CONNECTED_SITE\nJan 20 21:46:50 wmpc NetworkManager[734]: <info>  [1642690010.0196] manager: NetworkManager state is now CONNECTED_GLOBAL\nJan 20 21:57:00 wmpc NetworkManager[734]: <warn>  [1642690620.4089] sup-iface[0x55b52f610120,wlxf428531ddf06]: connection disconnected (reason -4)\nJan 20 21:57:00 wmpc NetworkManager[734]: <info>  [1642690620.4278] device (wlxf428531ddf06): supplicant interface state: completed -> disconnected\nJan 20 21:57:00 wmpc NetworkManager[734]: <info>  [1642690620.5123] device (wlxf428531ddf06): supplicant interface state: disconnected -> scanning\nJan 20 21:57:15 wmpc NetworkManager[734]: <warn>  [1642690635.5544] device (wlxf428531ddf06): link timed out.\nJan 20 21:57:15 wmpc NetworkManager[734]: <info>  [1642690635.5555] device (wlxf428531ddf06): state change: activated -> failed (reason 'ssid-not-found', sys-iface-state: 'managed')\nJan 20 21:57:15 wmpc NetworkManager[734]: <warn>  [1642690635.5590] device (wlxf428531ddf06): Activation: failed for connection 'mywifi'\nJan 20 21:57:15 wmpc NetworkManager[734]: <info>  [1642690635.5604] device (wlxf428531ddf06): state change: failed -> disconnected (reason 'none', sys-iface-state: 'managed')\nJan 20 21:57:15 wmpc NetworkManager[734]: <info>  [1642690635.5837] manager: NetworkManager state is now CONNECTED_LOCAL\nJan 20 21:57:20 wmpc NetworkManager[734]: <info>  [1642690640.1888] device (wlxf428531ddf06): supplicant interface state: scanning -> inactive\n")),(0,r.kt)("p",null,"The link timed out at around 10 PM on Thursday, and it didn't reconnect."),(0,r.kt)("p",null,"After some googling, I found out the reason here: ",(0,r.kt)("a",{parentName:"p",href:"https://community.home-assistant.io/t/wifi-does-not-reconnect-if-router-was-gone/247532/5"},"https://community.home-assistant.io/t/wifi-does-not-reconnect-if-router-was-gone/247532/5")),(0,r.kt)("p",null,"When I ran ",(0,r.kt)("inlineCode",{parentName:"p"},"nmcli con show my-network"),", I saw these lines in the output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"connection.autoconnect:                 yes\nconnection.autoconnect-priority:        0\nconnection.autoconnect-retries:         -1 (default)\n")),(0,r.kt)("h2",{id:"the-solution"},"The solution"),(0,r.kt)("p",null,"So I ran:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell-session"},"$ sudo nmcli con mod my-network connection.autoconnect-retries 0\n")),(0,r.kt)("p",null,"That command updated the configuration into:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"connection.autoconnect:                 yes\nconnection.autoconnect-priority:        0\nconnection.autoconnect-retries:         0 (forever)\n")),(0,r.kt)("p",null,"To confirm that the settings will also be applied after a reboot, I checked ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/NetworkManager/system-connections/my-network.nmconnection"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"[connection]\nid=mywifi\nuuid=01234567-89ab-cdef-0123-456789abcdef\ntype=wifi\nautoconnect-retries=0\n")),(0,r.kt)("p",null,"With this setting in place, the configuration will survive reboots."))}h.isMDXComponent=!0}}]);